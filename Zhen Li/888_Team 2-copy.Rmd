---
title: "BA888_TEAM2"
output: html_notebook
author: Andy Kim, Mandi Zhu, Jiaying Hu, Hui Jiang, Zhen Li, Jingxuan Ma
---

### I.Data Sources 
Kaggle: https://www.kaggle.com/sirpunch/meetups-data-from-meetupcom.

### II.The Business Problem
Clustering members/groups to see any similar characteristics.

Text Analysis based on “description” and “bio” to see what users have thought about events.

Recommender system based in R or Python after the market basket analysis and the clustering.

### III.Packages
```{r}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(quanteda)
library(tidytext)
library(topicmodels)
library(factoextra)
library(cluster)
library(streamgraph)
library(plotly)
library(sentimentr)
library(Rtsne)
library(caret)
library(class)
library(tidymodels)
library(xgboost)
library(rvest)
library(leaflet)
```

### IV.Load Raw Data 
```{r}
setwd('~/Desktop/Meetup/')
raw_cat<-read_csv('meetups-data-from-meetupcom/categories.csv')
raw_cit<-read_csv('meetups-data-from-meetupcom/cities.csv')
raw_eve<-read_csv('meetups-data-from-meetupcom/events.csv')
raw_g_top<-read_csv('meetups-data-from-meetupcom/groups_topics.csv')
raw_grp<-read_csv('meetups-data-from-meetupcom/groups.csv')
raw_m_top<-read_csv('meetups-data-from-meetupcom/members_topics.csv')
raw_mem<-read_csv('meetups-data-from-meetupcom/members.csv')
raw_top<-read_csv('meetups-data-from-meetupcom/topics.csv')
raw_ven<-read_csv('meetups-data-from-meetupcom/venues.csv')
```

### V.Clean Data & Skim Data
Remove some redundant columns (eg. Country, URL related columns).

Remove observations having missing (NA) data.  

#### 1. Categories:
33 categories (all unique); no missing value.
```{r}
skimr::skim(raw_cat)
head(raw_cat,5)
length(unique(raw_cat$category_id))
categories = raw_cat
```
Summary:For table raw_cat, it has 4 columns "category_id, category_name, shortname, sort_name", and 33 rows.

#### 2. Cities:
```{r}
skimr::skim(raw_cit)
head(raw_cit,5)
unique(raw_cit$city)
```
Summary: There are 5 variables in the table, they indicate the city the user is in, the distance, etc. Through screening, we counted 12 different cities.

#### 3. Event:
##### Drop meaningless cols (all rows the same): event_status,event_url,fee.description,photo_url,venue.localized_country_name,visibility,why

Number of unique group id: 341

Number of unique event id: 5897
```{r}
skimr::skim(raw_eve)
head(raw_eve,5)
events<-raw_eve %>% select(-c(event_status,event_url,fee.description,photo_url,venue.localized_country_name,visibility,why))
#unique event VS unique group
length(unique(events$group_id)) 
length(unique(events$event_id))  
```
Summary: This dataset is mainly some group and event statistics. We screened out the first five events according to the date, and then obtained a total of 341 different groups and 5,897 different events.

#### 4. Group & Topic 
A topic matches multiple groups.Cross reference table to map many-to-many relationship between Topic and Group table

Number of unique topic id: 961

Number of unique group id: 11876

Total Number of group id: 31212
```{r}
skimr::skim(raw_g_top)
nrow(raw_g_top)
#unique topic VS unique group
length(unique(raw_g_top$topic_id)) 
length(unique(raw_g_top$group_id)) 
```
Summary:Group_Topic has 4 columns, topic_id, topic_key, topic_name,group_id.One toptic id can matches more than one group id.

#### 5. Group 
##### Drop meaningless cols (all rows thE same): group_photo.base_url,group_photo.highres_link,group_photo.photo_link group_photo.thumb_link,group_photo.type,join_mode,link,organizer.photo.base_url, organizer.photo.highres_link,organizer.photo.photo_link,organizer.photo.thumb_link organizer.photo.type,urlname,group_photo.photo_id

Number of unique group id: 16330 (All unique)
```{r}
skimr::skim(raw_grp)
length(unique(raw_grp$group_id)) 
#Drop meaningless cols (all rows the same)
groups<-raw_grp %>% select(-c(group_photo.base_url,group_photo.highres_link,group_photo.photo_link,group_photo.thumb_link,group_photo.type,join_mode,link,
                              organizer.photo.base_url,organizer.photo.highres_link,organizer.photo.photo_link,organizer.photo.thumb_link,
                              organizer.photo.type,urlname,group_photo.photo_id))
```
Summary: The dataset of groups has 36 colunms anf 16330 raws, shows the name, description, categories, number of members of groups. 

#### 6. Members_topics

A topic matches multiple members.Cross-reference table for mapping many-to-many relationship between members and topics tables

Number of unique topic id: 1623 (vs.961 unique topic id in group & topic))

Number of unique member id: 605790
```{r}
skimr::skim(raw_m_top)
length(unique(raw_m_top$topic_id))  
length(unique(raw_m_top$member_id))  
nrow(raw_m_top)
```
Summary: The dataset has 4 columns and 3195245 rows. By deep observing, we found that one topic may have a lot members, which means for a same row, there would be same topics exist.

#### 7. Members 

A member matches multiple groups.Cross-reference table for mapping many-to-many relationship between members and groups tables.

Number of unique member id: 1087923
```{r}
skimr::skim(raw_mem)
length(unique(raw_mem$member_id))  
members<-raw_mem %>% select(-link)
```
Summary: The dataset on the members has 14 variables and 1087923, after observing, we found that one member may attend more than one groups.

#### 8.Topics 

Number of unique topic id: 2509
```{r}
skimr::skim(raw_top) 
length(unique(raw_top$topic_id)) 
topics<-raw_top %>% select(-link)
length(unique(topics$topic_id))
```
Summary: Topic has 7 columns topic_id,description, link,members,topic_name,urlkey,main_topic_id.

#### 9.Venue
```{r}
skimr::skim(raw_ven)
```
Summary: The dataset has 7 columns and 2509 rows, mainly the information of some topics, such as the description of topics, websites, names, members and so on.

### VI.How Many Years Does The Data Cover?
```{r}
head(groups$created)
years<-unique(year(groups$created)) 
year_span<-length(years)
```
Data covers from 2002 to 2017, 16 years.

### VII.Number of New Members Over Years Among 3 States  (NY, Chicago and SF)
```{r}
# Exclude cities that are not NY, Chicago and SF
members <-members %>% mutate(year_joined=factor(year(joined))) %>% 
  filter(state == "NY"|state == "IL"|state == "CA"|state == "ca") 
members$state[members$state=='ca']<-'CA'

# Plot
members %>% ggplot(aes(x=year_joined,fill=state)) +
  geom_bar(position = 'stack') +
  scale_fill_manual(values=c("#ef4566", "#f69a9a", "#f9cdae",'#cbcba9','#83ae9b'))+
  theme(axis.text.x=element_text(angle = 30, hjust = 1))+
  labs(title ="Number of New Members Over Years Among 3 States" , x = "Year", y = "Number of New Members")
```
The new members is continually increasing from 2002 to 2017. The growth rate is highest in 2015, then becomes lower. 

### VIII.Number of New Events Over Years Among 3 States(NY, Chicago and SF)
```{r}
# Exclude cities that are not NY, Chicago and SF
events <-events %>% mutate(year_created=factor(year(group.created))) %>% 
  filter(venue.state == "NY"|venue.state == "IL"|venue.state == "CA"|venue.state == "Il") 
events$venue.state[events$venue.state=='Il']<-'IL'
#Plot
events %>% ggplot(aes(x=year_created,fill=venue.state)) +
  geom_bar(position = 'stack') +
  scale_fill_manual(values=c("#ef4566", "#f69a9a", "#f9cdae",'#cbcba9','#83ae9b'))+
  theme(axis.text.x=element_text(angle = 30, hjust = 1))+
  labs(title ="Number of New Events Over Years Among 3 States " , x = "Year", y = "Number of New Events")
```
We noticed there is a big drop happened in 2016, indicating the Meetup might have some pocily changes in 2016. After research, we find Meetup closed  singles groups in 2016.

### IX.Popularity of (33) Categories Based on No.of Groups Among 3 States (NY, Chicago and SF)
```{r}
# Exclude cities that are not NY, Chicago and SF
cities<-raw_cit %>% filter(state == "NY"|state == "IL"|state == "CA")
groups <-groups %>% filter(state == "NY"|state == "IL"|state == "CA")

# Join dataset "groups" and 'categories' The number of category id is still 33.
grp_cate<-inner_join(groups,categories)
length(unique(grp_cate$category_id)) 

order<-with(grp_cate,table(category.name)) %>%  sort() %>% names()
# Plot
grp_cate %>% ggplot(aes(x=factor(category.name,level=order),fill=state)) +
  geom_bar(position = 'stack') +
  scale_fill_manual(values=c("#ef4566", "#f69a9a", "#f9cdae",'#cbcba9','#83ae9b')) +
  #theme(axis.text.x=element_text(angle = 30, hjust = 0)) +
  coord_flip()+
  labs(title ="Popularity of (33) Categories Based on No.of Groups Among 3 States " , x = "Category", y = "Count")
```
Meetup is most popular in NY. IL is the second popular and CA is the thrid.
The top three popular categories are tech,career,socializing.

### X.Top Popular Groups Based on No.of Members Among 3 States (NY, Chicago and SF)
```{r}
order1<-groups$group_name[rev(order(groups$members,decreasing = T)[1:20])] 
# Plot
groups[order(groups$members,decreasing = T),] %>% head(20) %>% 
  ggplot(aes(x=factor(group_name,level=order1),y=members)) +
  geom_col(fill="#ef4566") +
  coord_flip()+
  labs(title ="Top Popular Groups Based on No. of Members Among 3 States" , x = "Group Name", y = "Number of Members")
```
Among NY, Chicago and SF, the trends of popular categories/topics over years as shown in 'categories graph', tech, career/business, socializing are top three categories categories (No. of groups)'

### XI.Popularity Trend of Top 3 Categories Based on No.of Groups Among 3 States (NY, Chicago and SF)

```{r}
tmp<-groups %>% filter(category.name=='tech'|category.name=='career/business'|category.name=='socializing') %>% 
  mutate(year_created=factor(year(created)))
# Plot
ggplot(tmp, aes(x=year_created,color=category.name,shape=category.name)) + geom_point(stat='count',size=5)+
  facet_grid(.~state) +
  theme(axis.text.x=element_text(angle = 60, hjust = 1))+
  labs(title ="Popularity Trend of Top 3 Categories Based on No.of Groups Among 3 States" , x = "Year", y = "Category")
```
All of three categories are continuously increasing. In NY, tech and business were increased rapidly after 2010. In SF, tech increased much faster than other two categories. Compare to NY and SF The growth rate was lower in IL.

### R shiny - map area of each topic
boston_crime_2016 <- Crime_Aggregate_Data %>% select(OFFENSE_CODE_GROUP,Lat,Long,YEAR) %>% filter(YEAR == 2016) %>% filter(OFFENSE_CODE_GROUP %in% c('Simple Assault','Aggravated Assault','Violations')) %>% group_by(OFFENSE_CODE_GROUP)
boston_crime_2016$location <- ifelse(boston_crime_2016$OFFENSE_CODE_GROUP == "Simple Assault", "#a9a9a9",
    ifelse(boston_crime_2016$OFFENSE_CODE_GROUP == "Aggravated Assault", "red", ifelse(boston_crime_2016$OFFENSE_CODE_GROUP == "Violations" , "blue", "black")
)
)
boston_crime_2016 <-na.omit(boston_crime_2016)
boston_crime_2016 <- boston_crime_2016[-c(which(grepl(-1,boston_crime_2016$Long))), ]
leaflet() %>%
 addTiles() %>%
 addCircleMarkers(boston_crime_2016$Long,
                  boston_crime_2016$Lat,
                  color = boston_crime_2016$location,
                  radius = 0.5,
                  fill = T,
                  fillOpacity = 0.2,
                  opacity = 0.6,
                  popup = paste(boston_crime_2016$OFFENSE_CODE_GROUP,boston_crime_2016$Lat,boston_crime_2016$Long,sep = "")) %>%
 addLegend("topright",
           colors = c("#a9a9a9","red", "blue"),
           labels = c("Simple Assault",
                      "Aggravated Assault",
                      "Violations"),
           opacity = 2.0)


## Distribution of five categories amond the 3 states
```{r}
skim(groups)
View(groups)
skim(group_temp)
View(group_temp)
View(group_category)
skim(group_category)
group_temp <- groups
group_temp$created <- format(group_temp$created, "%Y")
group_category <- group_temp %>% select(category.shortname, lat, lon, created) %>% filter(category.shortname %in% c('tech', 'socializing', 'career-business', 'outdoors-adventure', 'language')) %>% group_by(category.shortname)
group_category$location <- ifelse(group_category$category.shortname == 'tech', '#ed1c40',
                                  ifelse(group_category$category.shortname == 'socializing', 'yellow', 
                                         ifelse(group_category$category.shortname == 'career-business', 'blue',
                                                ifelse(group_category$category.shortname == 'outdoors-adventure', 'green',
                                                         ifelse(group_category$category.shortname == 'language', 'purple', 'black')))))

leaflet() %>%
 addTiles() %>%
 addCircleMarkers(group_category$lon,
                  group_category$lat,
                  color = group_category$location,
                  radius = 0.5,
                  fill = T,
                  fillOpacity = 0.2,
                  opacity = 0.6,
                  popup = paste(group_category$category.shortname,group_category$lat,group_category$lon,sep = "")) %>%
 addLegend("topright",
           colors = c("#ed1c40","yellow", "blue", "green", "purple"),
           labels = c("tech",
                      "socializing",
                      "career-business",
                      "outdoors-adventure",
                      "language"),
           opacity = 2.0)
```

## overall category
```{r}
group_temp <- groups
View(groups)
skim(group_temp)
View(group_temp)
group_category <- group_temp %>% select(category.shortname, lat, lon, created, state) %>% filter(category.shortname %in% c('tech', 'socializing', 'career-business', 'outdoors-adventure', 'language')) %>% group_by(category.shortname)
View(group_category)
skim(group_category)
group_category$location <- ifelse(group_category$category.shortname == 'tech', '#ed1c40',
                                  ifelse(group_category$category.shortname == 'socializing', 'yellow', 
                                         ifelse(group_category$category.shortname == 'career-business', 'blue',
                                                ifelse(group_category$category.shortname == 'outdoors-adventure', 'green', test =
                                                         ifelse(group_category$category.shortname == 'language', 'orange','purple')))))

group_category <- group_category[-c(which(grepl(-1, group_category$lon))), ]

leaflet() %>%
 addTiles() %>%
 addCircleMarkers(group_category$lon,
                  group_category$lat,
                  color = group_category$location,
                  radius = 0.5,
                  fill = T,
                  fillOpacity = 1,
                  opacity = 1,
                  popup = paste(group_category$category.shortname,group_category$lat,group_category$lon,sep = "")) %>%
 addLegend("topright",
           colors = c("#ed1c40","yellow", "blue", "green", "purple"),
           labels = c("tech",
                      "socializing",
                      "career-business",
                      "outdoors-adventure",
                      "language"),
           opacity = 2.0)
```

